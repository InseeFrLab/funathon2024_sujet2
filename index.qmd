---
title: "Un tableau de bord du trafic a√©rien avec {{< fa brands r-project >}} ou {{< fa brands python >}}"
number-sections: true
filters:
   - include-code-files
---

```{=html}
<a href="https://datalab.sspcloud.fr/launcher/ide/rstudio?version=1.15.25&autoLaunch=true&networking.user.enabled=true&git.repository=¬´https%3A%2F%2Fgithub.com%2FInseeFrLab%2Ffunathon2024_sujet2.git¬ª&onyxia.friendlyName=¬´config-funathon2024¬ª&kubernetes.role=¬´admin¬ª" target="_blank" rel="noopener"><img src="https://img.shields.io/badge/SSP%20Cloud-Ouvrir_dans_RStudio-blue?logo=rstudio&amp;logoColor=blue" alt="Onyxia"></a>
```


# Introduction

## Objectif

L'objectif de ce tutoriel est d'amener, pas √† pas, √† la conception
voire √† la mise √† disposition d'un tableau de bord (_dashboard_)
du trafic a√©rien avec {{< fa brands r-project >}}.
Une d√©monstration de cette application est disponible √† l'adresse <https://rplane-dashboard.kub.sspcloud.fr/>. Ce tutoriel est √©galement l'occasion d'apprendre quelques bonnes pratiques pour les projets {{< fa brands r-project >}} et {{< fa brands python >}}.


Afin de se concentrer sur la d√©marche, cette application interactive
pr√©sentera un nombre limit√© de fonctionnalit√©s. L'objectif est de construire
progressivement celle-ci en suivant les √©tapes logiques du d√©roulement d'un
projet de d√©veloppement d'application interactive: d√©couverte et exploration des donn√©es, cr√©ation de statistiques
descriptives et de visualisations simples sur un jeu de donn√©es, 
extension du nombre de visualisations accessibles par la cr√©ation d'une application. Ce tutoriel est √©galement l'occasion de d√©couvrir quelques
bonnes pratiques de programmation avec {{< fa brands r-project >}}
afin de rendre les projets plus
fiables, √©volutifs et lisibles. 

Les exercices de conception pas √† pas de l'application s'adressent aussi bien √† des
d√©butants qu'√† des utilisateurs plus experts. La mise √† disposition, c'est-√†-dire
la mise en production de cette application, fait appel √† des concepts
et outils plus
avanc√©s et est donc moins accessible √† des d√©butants.

::: callout-tip
Si vous d√©sirez aller plus loin sur certaines dimensions de ce projet,
vous pouvez tout √† fait essayer de vous-m√™mes d'introduire de nouveaux
ingr√©dients dans l'application que vous d√©veloppez.
:::


## Pourquoi faire une application interactive ?

Cette question peut appara√Ætre naive. Pourtant, elle m√©rite d'√™tre pos√©e 
car elle permet de r√©fl√©chir √† l'objectif de l'application et √† son
public cible. Cette r√©flexion devrait √™tre men√©e syst√©matiquement car
elle guide les choix techniques ult√©rieurs et la r√©partition des t√¢ches entre
les diff√©rents profils pouvant intervenir dans la vie du projet s'il est mis en
production (statisticien ou _data scientist_, √©quipes informatiques...). 

En g√©n√©ral, on fait de la visualisation de donn√©es car les sources de donn√©es
exploit√©es pr√©sentent tellement de dimensions pouvant int√©resser un utilisateur
qu'il est plus pertinent de le laisser explorer les donn√©es que de d√©finir
pour lui les statistiques √† mettre en avant. L'interactivit√© permise par les sites
web est particuli√®rement adapt√©e pour cela: le fait d'afficher ou masquer
des visualisations en fonction de choix de l'utilisateur
√©vite de noyer l'information par rapport √† des supports fig√©s.

Les _frameworks_ `Shiny` ({{< fa brands r-project >}}),
`Streamlit` ou `Dash` ({{< fa brands python >}}) permettent de rapidement
mettre en oeuvre ce type de site web. Pour une phase de construction
d'un prototype, c'est un choix technique int√©ressant qui peut provoquer l'effet
_wahou_ attendu pour lancer le projet √† plus grande √©chelle. En effet, ces solutions
techniques permettent, avec les outils bien connus des praticiens de la donn√©e, {{< fa brands r-project >}} ou {{< fa brands python >}} principalement, de cr√©er rapidement un site web fonctionnel, ergonomique et effectuant des op√©rations en fonction d'actions de l'utilisateur
sur la page web. Tout ceci sans avoir √† ma√Ætriser des notions complexes de
d√©veloppement web. 

N√©anmoins, pass√©e cette phase d'exp√©rimentation,
le partage
de ces applications, au-del√† d'un partage d'√©cran pour des d√©monstrations,
est moins √©vident. C'est parce que la connaissance de ces notions complexes qui permettent le bon fonctionnement d'un site web et dont la ma√Ætrise n'est pas n√©cessaire lorsqu'on se lance dans la construction du site deviennent utiles pass√©e la phase d'exp√©rimentation. 
Celles-ci d√©passent n√©anmoins le champ de comp√©tence
des statisticiens ou _data scientists_. 

Autrement dit, si le projet a l'ambition d'√™tre partag√©
√† une audience large qui n'a pas les comp√©tences techniques pour faire tourner elle-m√™me
le code, il convient de prendre en compte le fait qu'il faudra dans l'√©quipe projet
des comp√©tences de d√©veloppement web. Si le projet est exp√©rimental, c'est moins un probl√®me: `Shiny`, `Dash` ou `Streamlit` permettront d'avoir rapidement un prototype viable. 

Il existe heureusement des solutions techniques plus simples √† mettre en oeuvre que `Shiny`,
`Streamlit` ou `Dash`. Les sites web statiques font partie de cet
√©ventail des possibles et repr√©sentent souvent une alternative pertinente aux applications interactives √† condition qu'ils soient bien pens√©s. 
Ils sont notamment pertinents pour les applications de visualisation
de donn√©es o√π cette derni√®re est d√©j√† pr√©par√©e en amont. Avoir un serveur `R` ou `Python`
se justifie en effet si des √©tapes complexes de structuration de donn√©es interviennent. N√©anmoins, si celles-ci ne sont pas n√©cessaires, un
simple enrobage avec un constructeur de site comme `Quarto` peut suffire, √† condition
que
les productions graphiques ne soient pas trop complexes √† cr√©er. Pour des sites faisant intervenir des interactions complexes entre actions d'un utilisateur (bouton, menu d√©roulant, etc. ) et
affichage, il faudra recourir √† du  `Javascript` (technologie utilis√©e par les sites sp√©cialis√©s dans la _dataviz_), ce qui fait, √† nouveau, appel √† des comp√©tences qui d√©passent celles des _data scientists_ ou statisticiens classiques. 

En r√©sum√©, les √©l√©ments ci-dessus ont vocation √† servir de mise en garde. `Shiny`, `Dash` ou `Streamlit` sont d'excellents outils techniques lorsqu'ils sont utilis√©s √† bon escient. N√©anmoins, leur simplicit√© d'usage ne doit pas amener √† oublier de se poser des questions vitales comme celui du cycle de vie du projet, du public cible ou encore de la comp√©tence des √©quipes amen√©es √† le maintenir s'il perdure au-del√† d'une phase d'exp√©rimentation.

::: {.callout-warning collapse="true"}
## Site statique vs application r√©active

La solution que nous allons proposer 
pour les sites statiques, `Quarto` associ√©
√† `Github Pages`, peut √™tre utilis√©e dans le cadre des parcours 
_"rapport reproductible"_ ou _"dashboard / application interactive"_. 

La distinction principale entre ces deux approches est qu'elles
s'appuient sur des serveurs diff√©rents. Un site statique repose
sur un serveur web l√† o√π `Streamlit` s'appuie sur 
serveur classique en _backend_. La diff√©rence principale
entre ces deux types de serveurs
r√©side principalement dans leur fonction et leur utilisation:

- Un __serveur web__ est sp√©cifiquement con√ßu pour stocker, traiter et livrer des pages web aux clients. Cela inclut des fichiers HTML, CSS, JavaScript, images, etc. Les serveurs web √©coutent les requ√™tes HTTP/HTTPS provenant des navigateurs des utilisateurs et y r√©pondent en envoyant les donn√©es demand√©es.
- Un **serveur _backend_** classique est con√ßu pour effectuer des op√©rations en r√©ponse √† un _front_, en l'occurrence une page web. 
Dans le contexte d'une application `Streamlit` (resp. `Shiny`), il s'agit d'un serveur avec l'environnement `Python` (resp. `R`) _ad hoc_ pour
ex√©cuter le code n√©cessaire √† r√©pondre √† toute action d'un utilisateur de l'application. 

:::



# Exploration des donn√©es de trafic a√©rien

TO DO: expliquer la d√©marche

## Pr√©liminaire: r√©cup√©rer le projet squelette avec `Git` {{< fa brands git-alt >}}

Si vous disposez d'un compte sur le [sspcloud](https://www.sspcloud.fr/),
la m√©thode recommand√©e pour se lancer dans ce tutoriel est de cliquer
sur le bouton suivant

```{=html}
<center>
<a href="https://datalab.sspcloud.fr/launcher/ide/rstudio?version=1.15.25&autoLaunch=true&networking.user.enabled=true&git.repository=¬´https%3A%2F%2Fgithub.com%2FInseeFrLab%2Ffunathon2024_sujet2.git¬ª&onyxia.friendlyName=¬´config-funathon2024¬ª&kubernetes.role=¬´admin¬ª" target="_blank" rel="noopener"><img src="https://img.shields.io/badge/SSP%20Cloud-Ouvrir_dans_RStudio-blue?logo=rstudio&amp;logoColor=blue" alt="Onyxia"></a>
</center>
<br>
```



Si vous avez utilis√© le lien de lancement rapide mis √† disposition
sur la page [inseefrlab.github.io/funathon2024/](https://inseefrlab.github.io/funathon2024/)
ou ci-dessus ‚òùÔ∏è, 
vous pouvez sauter l'√©tape de r√©cup√©ration du mod√®le de projet avec `Git` {{< fa brands git-alt >}}, cela
a √©t√© fait automatiquement lors de la cr√©ation de votre environnement `RStudio`. 
Cela ne vous dispense d'ailleurs pas de faire du `Git` tout au long du tutoriel,
c'est une bonne pratique, m√™me sur
des projets ponctuels ou vous √™tes seuls √† travailler. 

::: {.callout-note collapse="true"}
## R√©cup√©rer le projet si vous n'avez pas utilis√© le bouton propos√©

:::: {.panel-tabset}
## Interface graphique

La fiche `utilitR` sur l'[utilisation de `Git`](https://book.utilitr.org/03_Fiches_thematiques/Fiche_git_utilisation.html#recuperer-url
) explicite la d√©marche g√©n√©rale pour
r√©cup√©rer du code gr√¢ce √† `Git`. Il est recommand√© de lire celle-ci si vous
n'√™tes pas familier de `Git`. 

Les √©tapes suivantes permettront de r√©cup√©rer le projet:

1Ô∏è‚É£ En premier lieu, dans `RStudio`, cr√©er un nouveau projet et s√©lectionner `Version Control`. 

![](https://book.utilitr.org/pics_resized/git/create_project_1.png)

2Ô∏è‚É£ Choisir `Git`, ce qui devrait ouvrir une fen√™tre similaire √† celle ci-dessous:

![](https://book.utilitr.org/pics_resized/git/create_project_2.png)

3Ô∏è‚É£ Dans la fen√™tre `Repository URL`, passer la valeur

```r
https://github.com/inseefrlab/funathon2024_sujet2.git
```

laisser les valeurs par d√©faut qui viennent ensuite et cr√©er le projet. 


## Depuis le terminal

Apr√®s avoir ouvert un terminal dans `RStudio`, faire 

```bash
git clone https://github.com/inseefrlab/funathon2024_sujet2.git
```

puis, dans l'explorateur de fichiers (fen√™tre en bas √† droite), cliquer
sur le fichier `RTraffic.Rproj` pour ouvrir le projet. 
::::

:::

Le projet r√©cup√©r√© comporte de nombreux fichiers. Nous allons 
progressivement les d√©couvrir dans ce tutoriel. A l'heure actuelle,
on peut se concentrer sur les fichiers suivants:

```
|- renv.lock
|- global.R
|- server.R
|- ui.R
```

Le premier fichier correspond √† la liste des _packages_ n√©cessaires
pour reproduire l'environnement. Il a √©t√© g√©n√©r√© automatiquement gr√¢ce √† 
un √©cosyst√®me `renv` particuli√®rement adapt√© pour assurer la reproductibilit√©
de projets `R` (voir la suite). 

Les fichiers `server.R` et `ui.R` constituent le coeur de notre application 
`Shiny`. Ils repr√©sentent, respectivement, le moteur de calcul (le serveur)
et l'interface utilisateur de notre application. Le fichier `global.R` stocke
un certain nombre d'objets utiles √† l'application mais qui n'ont pas besoin
d'√™tre recalcul√© √† chaque action sur l'interface graphique. Nous allons progressivement construire ces fichiers pendant les diff√©rents exercices.


## Installer les _packages_ n√©cessaires pour ce tutoriel

### Principe

Pour progresser dans ce tutoriel, un certain nombre de _packages_
doivent √™tre install√©s. Sans eux, m√™me avec le code de l'application, vous
ne serez pas en mesure de reproduire celle-ci. 

Les bonnes pratiques pour la gestion de 
l'environnement sont assez proches en {{< fa brands r-project >}} et {{< fa brands python >}}.
Le principal g√©n√©ral est qu'il existe des outils qui permettent √† un utilisateur de lister l'ensemble des packages dans son environnement avec leur version. Gr√¢ce √† cette liste, d'autres personnes pourront reproduire l'application si elles disposent des m√™mes _inputs_ (le code, les donn√©es...). 

En effet, il est important de voir l'application comme le r√©sultat de la combinaison de plusieurs ingr√©dients. Dans notre cas, nous en avons trois:

* Du code `R` ou `Python` : celui-ci a √©t√© r√©cup√©r√© par le biais de `Git`
* Des √©l√©ments de configuration:
    + le fichier `renv.lock` (`R`) ou `requirements.txt` (`Python`) qui permettra de reconstruire notre environnement √† l'identique gr√¢ce √† des outils adapt√©s[^generation]
    + le fichier `sources.yaml` qui liste l'emplacement des sources sur le site [data.gouv](https://www.data.gouv.fr/fr/)
* Des donn√©es: nous √©voquerons celles-ci lors de la prochaine partie.


![Illustration du principe de s√©paration du code, des donn√©es et de la configuration](./img/environment.png)

De mani√®re g√©n√©rale, c'est une bonne pratique de structurer son projet comme une
combinaison de ces facteurs. Cela vous am√®nera √† faire des projets plus reproductible
mais aussi √† la structure plus lisible. 

Pour les utilisateurs de `R`, la [formation de l'Insee aux bonnes pratiques](https://inseefrlab.github.io/formation-bonnes-pratiques-git-R/)
consacre une partie aux environnements reproductibles avec `renv`. Pour les utilisateurs
de `Python`, le [cours de mise en production de projets _data science_](https://ensae-reproductibilite.github.io/website/chapters/portability.html)
consacre un chapitre au sujet. 

[^generation]: Ces fichiers ne sont pas g√©n√©r√©s manuellement. Ce sont des outils adapt√©s (`renv` pour `R`, `pip` pour `Python`) qui font ce travail de versionnage de l'environnement. 

### Cr√©er l'environnement

Si vous avez d√©j√† tent√© de partager un code qui fonctionnait chez vous,
il est presque certain que la personne ayant voulu le r√©utiliser a rencontr√©
une erreur si elle a tent√© de le faire tourner. C'est tout √† fait normal car
vous avez distribu√© votre code, √©ventuellement vos donn√©es, mais pas le troisi√®me
pilier de l'image pr√©c√©dente, √† savoir la configuration de l'environnement dans lequel votre code fonctionnait. La solution la plus fiable, mais peu pratique, serait de donner votre ordinateur √† la personne qui tente de r√©utiliser votre code. En livrant votre ordinateur, vous fournissez votre environnement de travail mais √©galement beaucoup d'√©l√©ments suppl√©mentaires qui ne sont pas indispensables √† l'application.

Une solution plus simple est de fournir les sp√©cifications qui ont permis √† votre
code de fonctionner. Dans un monde id√©al, il s'agit de fournir la liste
des _packages_ et leur version. Si la personne √† qui vous partagez votre code et vos donn√©es a cette m√™me liste de versions de _packages_, et pas de _packages_ suppl√©mentaires venant polluer l'environnement, les chances d'avoir la m√™me application que vous sont tr√®s √©lev√©es. 

`renv` est un gestionnaire de _packages_ qui permet de faire ces deux op√©rations:

1. Enregistrer la liste de _packages_ apr√®s avoir fait tourn√© un code
2. Restaurer l'environnement √† partir de cette liste

En l'occurrence, pour vous, l'important est le second point: pouvoir recr√©er l'environnement n√©cessaire
au bon fonctionnement de l'application. Ceci est tr√®s simple gr√¢ce √† la commande

```r
renv::restore()
```

Cette commande doit √™tre lanc√©e depuis la console `R` ouverte dans le projet qui
a √©t√© r√©cup√©r√©. L'environnement cr√©√© n'est pas fig√©. 
Il est tout √† fait possible, ensuite, d'installer des _packages_ suppl√©mentaires
par le biais de `install.packages`. L'environnement propos√© par notre fichier
`renv.lock` est le minimum
requis pour reproduire l'application mais ce n'est pas un environnement fig√©.
Si vous ajoutez des _packages_ utiles pour votre application, avant la phase de mise en production, n'oubliez pas
de faire `renv::snapshot()` pour mettre √† jour le fichier `renv.lock` (c'est le point 1. √©voqu√© pr√©c√©demment). 


::: {.callout-warning collapse="true"}
## Ce que `renv` √©vite

On retrouve parfois sur internet un code similaire √† celui-ci :

```r
# A ne pas reproduire chez vous üò®
if (!requireNamespace("dplyr", quietly = TRUE)) {
  install.packages("dplyr")
}
```

C'est une gestion artisanale de l'environnement qui n'est pas conseill√©e. `renv` sera plus simple et
plus fiable.

:::

Maintenant que nous disposons d'un environnement fonctionnel, 
nous pouvons avancer sur la conception du projet. La premi√®re √©tape est d'explorer
les jeux de donn√©es que nous utiliserons dans l'application.

# R√©cup√©rer les donn√©es

Les sources sont list√©es dans le fichier `sources.yaml`. 
Notre application utilisera quatres sources diff√©rentes:

- Le trafic au niveau de chaque a√©roport (format CSV)
- Le nombre de passagers pour diff√©rentes liaisons (format CSV)
- Le trafic pour diff√©rentes compagnies (format CSV)
- Les localisations des a√©roports (format geojson)

Une bonne pratique, lorsqu'on utilise plusieurs sources,
est de lister celles-ci dans un fichier `YAML` plut√¥t que de les inscrire
en brut dans le code. Ce dernier sera plus lisible gr√¢ce √† cette approche.

<details>
<summary>

Voir le fichier `sources.yml`

</summary>
```{.yaml include="sources.yml" filename="sources.yml"}
```
</details>


## Importer la liste des sources disponibles


::: {.callout-note collapse="false" icon=false}
## `<i class="bi bi-book"></i>`{=html} Exercice 1: lire les sources dans {{< fa brands r-project >}}

1. Le package `yaml` comporte une fonction `read_yaml` pour transformer
un fichier `YAML` en liste imbriqu√©e. Tester cette fonction sur le fichier `sources.yml`. 

2. Transformer ce bout de code en une fonction `create_data_list`
prenant un argument `source_file` et renvoyant cette liste.

:::

<details>
<summary>
Voir la solution √† cet exercice
</summary>
```{.r include="R/create_data_list.R"}
```


</details>

La solution est dans le fichier `R/create_data_list.R`. Elle peut √™tre import√©e
dans l'environnement global gr√¢ce √† la commande:

```{r}
source("R/create_data_list.R")
```

## Importer les premi√®res bases 

```{r}
urls <- create_data_list("sources.yml")
```


::: {.callout-note collapse="false" icon=false}
## `<i class="bi bi-book"></i>`{=html} Exercice 2: d√©couvrir les diff√©rentes sources

Cet exercice est, en apparence, un peu long. N√©anmoins la premi√®re partie
de celui-ci permet la construction d'une fonction g√©n√©rique d'import
des donn√©es qui permet ensuite de gagner
du temps et d'√©viter la redondance de code. 

#### Donn√©es a√©roports {.unnumbered}

* Comme les donn√©es sont des CSV europ√©ens (s√©parateur `;`),
utiliser `read_csv2` du package `readr` pour lire les donn√©es √† partir 
de la liste de fichiers `unlist(urls$airports)`[^utilitr-csv].
* Il est recommand√© de ne pas laisser les types par d√©faut des colonnes mais de figer ceux-ci avec l'argument suivant:

```{.r}
col_types = cols(
  ANMOIS = col_character(),
  APT = col_character(),
  APT_NOM = col_character(),
  APT_ZON = col_character(),
  .default = col_double()
)
```

* A partir de la variable `ANMOIS`, cr√©er les variables `an` et `mois`.

<details>
<summary>
Aide si vous √™tes bloqu√© sur cette question
</summary>

Pour extraire des √©l√©ments d'une chaine de caract√®re √† partir de la position, il est recommand√© d'utiliser la fonction `str_sub` du package `stringr`. Pour cr√©er de nouvelles colonnes, il est recommand√© d'utiliser la fonction `mutate` du package dplyr. 

::: {.callout-warning}
## Conseil pour se faciliter la vie ult√©rieurement

Il est recommand√© d'utiliser `str_remove` pour retirer les z√©ros en d√©but de mois
qui pourront nous cr√©er des difficult√©s ult√©rieurement
:::

Si vous √™tes toujours bloqu√©, la solution est donn√©e plus bas üëá

</details>

* Cr√©er une fonction `clean_dataframe` qui reprend le code de cr√©ation des variables `an` et `mois`, ajoute une √©tape de passage des noms de colonne en minuscule et renvoie le dataframe en sortie

<details>
<summary>
Solution
</summary>

```{.r include="R/clean_dataframe.R"}
```
</details>

* Cr√©er une fonction `import_airport_data` qui prend en _input_ `list_files`
et int√®gre les deux √©tapes pr√©c√©dentes: la lecture des donn√©es, le nettoyage
avec `clean_dataframe`.

<details>
<summary>
Solution
</summary>

```{.r include="R/import_data.R" start-line=1 end-line=17}
```

* Reporter cette fonction dans un fichier `R/clean_dataframe.R` et faire

```{.r}
source("R/clean_dataframe.R")
```

</details>

#### Donn√©es compagnies {.unnumbered}

Sur le m√™me principe, cr√©er une fonction `import_compagnies_data` qui effectue
la m√™me suite d'op√©rations. Faire n√©anmoins attention aux types des colonnes. 

```{r}
#| eval: false
#| code-fold: true
#| code-summary: "Recommandation de param√®tre pour read_csv pour l'import de ces fichiers"
col_types = cols(
  ANMOIS = col_character(),
  CIE = col_character(),
  CIE_NOM = col_character(),
  CIE_NAT = col_character(),
  CIE_PAYS = col_character(),
  .default = col_double()
)
```


<details>
<summary>
Solution
</summary>

```{.r include="R/import_data.R" start-line=20 end-line=38}
```

</details>

#### Donn√©es liaisons  {.unnumbered}

Sur le m√™me principe, cr√©er une fonction `import_liaisons_data` qui effectue
la m√™me suite d'op√©rations. Faire n√©anmoins attention aux types des colonnes. 

```{r}
#| eval: false
#| code-fold: true
#| code-summary: "Recommandation de param√®tre pour read_csv pour l'import de ces fichiers"
col_types = cols(
  ANMOIS = col_character(),
  LSN = col_character(),
  LSN_DEP_NOM = col_character(),
  LSN_ARR_NOM = col_character(),
  LSN_SCT = col_character(),
  LSN_FSC = col_character(),
  .default = col_double()
)
```

<details>
<summary>
Solution
</summary>

```{.r include="R/import_data.R" start-line=41 end-line=60}
```

</details>

#### Localisations des a√©roports {.unnumbered}

Il s'agit d'un jeu de donn√©es spatial. Pour en savoir plus sur ce type de donn√©es,
il est recommand√© de consulter la [fiche  `utilitR`](https://book.utilitr.org/03_Fiches_thematiques/Fiche_donnees_spatiales.html) sur
le sujet ou [ce cours introductif](https://rgeo.linogaliana.fr/exercises/geospatial-wrangling.html) 

1. Utiliser la fonction `st_read` du package `sf` pour lire ces donn√©es (dont la localisation est stock√©e dans la variable `urls$geojson$aiport`). Stocker l'objet obtenu sous le nom `airports_location`
2. V√©rifier que les donn√©es sont bien dans le syst√®me de repr√©sentation `WGS 84`[^crs]

<details>
<summary>
Aide
</summary>
La fonction √† utiliser est `sf_crs`
</details>

3. Il est toujours utile de v√©rifier que nos donn√©es sont bien localis√©es o√π on les attend. Pour cela, il est pertinent de faire une carte avec un fond de carte contextuel, m√™me si celle-ci n'est pas tr√®s soign√©e. Pour faire ceci, le plus simple est d'utiliser la [fonction `addMarkers`](https://rstudio.github.io/leaflet/articles/markers.html) du package `leaflet`.
Essayez de faire cette carte vous-m√™mes ou consultez l'aide ci-dessous

<details>
<summary>
Code pour faire une carte `leaflet` minimale
</summary>
```{.r}
leaflet(airports_location) %>%
  addTiles() %>%
  addMarkers(popup = ~Nom)
```
</details>

Reporter toutes ces fonctions dans un fichier `R/import_data.R`. 
:::

[^utilitr-csv]: Si vous √™tes peu familier avec ce type de fichiers, vous pouvez consulter la [fiche `utilitR`](https://book.utilitr.org/03_Fiches_thematiques/Fiche_import_fichiers_plats.html) sur le sujet
[^crs]: Si vous √™tes peu familier avec les donn√©es g√©ographiques, vous pouvez retenir l'id√©e qu'il s'agit de donn√©es traditionnelles auxquelles s'ajoute une dimension spatiale. Cette derni√®re vise √† localiser les donn√©es sur la terre. La localisation se fait dans un espace √† deux dimensions (espace cart√©sien) alors que notre plan√®te est une sph√®re en trois dimensions. Le principe d'un syst√®me de projection est de faire ce passage en deux dimensions des positions. Le plus connu est le syst√®me GPS, qui est un h√©ritier lointain de la repr√©sentation du monde par [Mercator](https://fr.wikipedia.org/wiki/G%C3%A9rard_Mercator). Ce syst√®me est connu sous le nom de WGS 84 et porte le code EPSG 4326. L'autre syst√®me √† retenir est le Lambert 93 (code EPSG 2154) qui est la projection l√©gale en France (celle-ci, _a contrario_ du Mercator, ne d√©forme pas la France sur une carte). Pour en savoir plus sur les syst√®mes de repr√©sentation, les avantages et inconv√©nients de chacun, il existe de nombreuses ressources en ligne. Des √©l√©ments introductifs, et des d√©monstrations interactives, en lien avec la librairie `Geopandas` de `Python` sont disponibles [ici](https://pythonds.linogaliana.fr/content/manipulation/03_geopandas_intro.html#principe). 


A l'issue de cet exercice, vous devriez avoir le fichier `R/import_data.R` suivant

<details>
<summary>
Le fichier `R/import_data.R` attendu
</summary>

```{.r include="R/import_data.R"}
```

</details>

La carte `leaflet` que vous devriez avoir obtenue √† la fin de l'exercice
est la suivante:

```{r}
#| echo: false
#| output: false
library(sf)
library(leaflet)
airports_location <- st_read(urls$geojson$airport)
```

```{r}
leaflet(airports_location) %>%
  addTiles() %>%
  addMarkers(popup = ~Nom)
```

A l'issue de l'exercice, 
le code centralis√© dans le script `R/import_data.R`
peut √™tre import√© via le code suivant

```{r}
source("R/import_data.R")  
```

Vous pouvez initier un script nomm√© `main.R` avec les lignes suivante:

```{.r include="global.R" start-line=24 end-line=34}
```

en les faisant pr√©c√©der de l'import des
scripts que nous avons d√©j√† cr√©√© dans le dossier `R`:

```r
source("R/create_data_list.R")
source("R/import_data.R")  
source("R/clean_dataframe.R")
```

Une bonne pratique est de tester son script dans une session vierge. Cela am√®ne
√† construire pas √† pas une chaine plus reproductible. Pour cela, 

- Aller dans les options de `R` via `Tools > Global Options` et d√©cocher la case `Restore .RData into workspace at setup`
- Red√©marrer votre
session `R` via le menu `Session > Restart R` ou le
raccourci <kbd>CTRL</kbd>+<kbd>SHIFT</kbd>+<kbd>F10</kbd>

Et ex√©cuter votre fichier `main.R`. Vous devriez rencontrer des erreurs car nous n'avons pas g√©r√© les import de librairies dans ce script puisque notre session actuelle ne b√©n√©ficie plus des import ant√©rieurs.

Une bonne pratique pour comprendre cette exigence de reproductibilit√©
est d'it√©rativement ajouter les librairies utiles √† mesure qu'on rencontre des erreurs (notre code √©tant tr√®s rapide √† tourner, cette logique d'essai-erreur n'est pas tr√®s co√ªteuse). 
Si vous ne d√©sirez pas faire ceci (dommage, c'est un bon exercice), vous
pouvez trouver les imports de packages √† faire pour que notre script soit
reproductible. 

<details>
<summary>
L'environnement minimal de reproductibilit√© pour que le script `main.R` fonctionne
</summary>

```{.r}
library(readr)
library(dplyr)
library(stringr)
library(sf)
``` 

</details>

Ces librairies sont √† √©crire au d√©but de `main.R`. 


# Exploration des donn√©es

```{r}
#| label: intermediates-exo2
#| echo: false
#| output: false
source("intermediates/exo2.R")
```


## Le trafic par a√©roport

Pour commencer, nous allons prototyper la production d'une figure
sur le trafic a√©rien au niveau d'un a√©roport. Cela nous facilitera ensuite
l'int√©gration dans une application interactive. 

Pour cela, nous allons cr√©er les deux objets temporaires suivants

```{r}
liste_aeroports <- unique(pax_apt_all$apt)
default_airport <- liste_aeroports[1]
default_airport
```

```{r}
#| output: false
#| echo: false
source("intermediates/exo3.R")
```

::: {.callout-note collapse="false" icon=false}
## `<i class="bi bi-book"></i>`{=html} Exercice 3: graphiques de fr√©quentation des a√©roports

1. Cr√©er une variable `trafic` √©gale `apt_pax_dep + apt_pax_tr + apt_pax_arr`
2. Ne conserver que les donn√©es relatives √† l'a√©roport `default_airport`
3. Cr√©er une variable `date` qui utilise les colonnes `an` et `mois`. Cette variable de date doit √™tre au format `date`, pas au format `chr`
<details>
<summary>
Encha√Ænement des op√©rations attendues √† cette √©tape
</summary>

```{.r include="intermediates/exo3.R" end-line=32}
```
</details>

4. Faire une figure `ggplot` toute simple pour voir la dynamique des donn√©es
afin d'obtenir une figure similaire √† celle-ci

```{r}
figure_ggplot
```

Nous allons faire une application interactive par la suite. Il est donc
plus int√©ressant d'avoir une figure un minimum r√©active pour impliquer
l'utilisateur de l'application.

5. Il est donc plus pertinent de faire une figure avec la librairie
`plotly`. Pour cela, vous pouvez vous inspirer de [cette page](https://plotly.com/r/line-charts/)

```{r}
#| echo: false
figure_plotly
```

<details>

<summary>
Le code pour g√©n√©rer la figure
</summary>

```{.r include="intermediates/exo3.R" start-line=15}
```

</details>

:::

Le code complet pour r√©pliquer cet exercice est donn√© ci-dessous. 

<details>
<summary>
Code de l'exercice
</summary>
```{.r include="intermediates/exo3.R"}
```
</details>

Nous proposons de le transformer en fonction, ce sera plus simple √† int√©grer
ult√©rieurement dans notre application

::: {.callout-note collapse="false" icon=false}
## `<i class="bi bi-book"></i>`{=html} Exercice 3b: une fonction de production graphique

Transformer le code ci-dessus en une fonction afin que

* les _inputs_ soient les suivants: un _dataframe_, un a√©roport √† s√©lectionner
* la sortie soit notre figure `plotly`

Tester la fonction sur d'autres a√©roports de la liste. Quand vous √™tes satisfaits de celle-ci, 
d√©placer la d√©finition de cette fonction dans `R/figures.R`
:::

<details>
<summary>
Fichier `R/figures.R` √† l'issue de cet exercice
</summary>
```{.r include="R/figures.R" end-line="18" filename="R/figures.R"}
```
</details>

Par la suite, nous pouvons ajouter la ligne suivante √† notre fichier `main.R`

```{r}
#| output: false
source("R/figures.R")
```

et utiliser cette fonction √† la fin du fichier. 

<details>
<summary>
Fichier `main.R` √† l'issue de cet exercice
</summary>
```{.r include="intermediates/exo3.R" filename="main.R"}
```
</details>


## Tableau HTML pour afficher des donn√©es

La premi√®re valorisation que nous int√©grerons dans notre application est
le mod√®le de figure ci-dessus. La deuxi√®me sera un tableau
permettant de visualiser certaines donn√©es directement dans le _dashboard_. 

Pour le prochain exercice, vous pourrez utiliser ces objets

```{r}
#| echo: true 
YEARS_LIST  <- as.character(2018:2022)
MONTHS_LIST <- 1:12
```


::: {.callout-note collapse="false" icon=false}
## `<i class="bi bi-book"></i>`{=html} Exercice 4a: pr√©parer les donn√©es avant de faire un beau tableau

Nous allons int√©grer dans notre application deux tableaux de
statistiques descriptives.

1. Choisir un mois et une ann√©e
√† partir des objets `YEARS_LIST` et `MONTHS_LIST` pour faire
un filtre sur le _dataframe_ `pax_apt_all`. Une fois
que vous √™tes satisfaits, transformer cela en
fonction `create_data_from_input` prenant en argument un _dataframe_, 
une ann√©e et un mois

<details>
<summary>
Code de l'exercice
</summary>
```{.r include="R/divers_functions.R" start-line=1 end-line=6}
```
</details>


2. Pour chaque a√©roport, calculer le nombre total
de passager. Rapporter cette statistique en million
de personnes. Puis classer les a√©rports du plus fr√©quent√©
au moins fr√©quent√©. Une fois que vous √™tes satisfaits de
votre chaine d'op√©ration, cr√©er une fonction `summary_stat_airport`.

<details>
<summary>
Code de l'exercice
</summary>
```{.r include="R/divers_functions.R" start-line=8 end-line=19}
```
</details>

3. Voici une fonction pour faire le m√™me type d'op√©ration sur la base des
liaisons. 

<details>
<summary>
Code de l'exercice
</summary>
```{.r include="R/divers_functions.R" start-line=21}
```
</details>

Reporter les fonctions cr√©√©es dans cet exercice dans un script `divers_functions.R`.
Enrichir le script `main.R` pour utiliser celles-ci en cr√©ant les _dataframes_
ad√©quats (correction ci-dessous)

:::

Voici une proposition de script `main.R` √† l'issue de cet exercice

<details>
<summary>
Code de l'exercice
</summary>
```{.r include="intermediates/exo4a.R"}
```
</details>

Nous avons maintenant tous les ingr√©dients pour faire un tableau de
statistiques descriptives lisible et esth√©tique. Pour cela, nous allons
utiliser le _package_ [`GT`](https://gt.rstudio.com/). Avant
de cr√©er cette table, nous allons cr√©er une colonne suppl√©mentaire:

```{r}
#| echo: false
#| output: false
source("intermediates/exo4a.R")
```

```{r}
stats_aeroports_table <- stats_aeroports %>%
  mutate(name_clean = paste0(str_to_sentence(apt_nom), " _(", apt, ")_")
) %>%
select(name_clean, everything())
```

Celle-ci nous permettra, une fois mise en forme, d'avoir une colonne
plus esth√©tique. 

::: {.callout-note collapse="false" icon=false}
## `<i class="bi bi-book"></i>`{=html} Exercice 4b: un beau tableau (enfin !)

Les diff√©rentes questions vont permettre de construire et formatter
progressivement notre tableau. Si vous √™tes bloqu√©s, les r√©ponses
sont ci-dessous dans des menus d√©roulants. 

1. En premier lieu, utiliser `GT` pour faire un tableau basique sur le _dataframe_ `stats_aeroports_table`.
N'utiliser
aucune option, celles-ci vont √™tre progressivement ajout√©es. 
2. Retirer les colonnes `apt` et	`apt_nom` de notre table. 

<details>
<summary>Il y a plusieurs
mani√®res de faire, voici un indice sur la "meilleure"
</summary>
Il est possible d'utiliser des fonctions de s√©lection de colonnes
issues du _tidyverse_ dans `gt`, notamment la fonction `starts_with` (√† ne pas
confondre avec celle de `stringr`)
</details>

3. Formatter les colonnes num√©riques (pour la s√©lection des colonnes num√©riques, voir l'indice ci-dessus). 
En consultant la documentation de `gt`, appliquer l'option qui permet de rendre plus concise la notation
des milliers (K) et millions (M). 

4. Utiliser `fmt_markdown` pour appliquer une mise en forme adapt√©e √† la colonne `name_clean`
5. Mettre en forme les noms de colonne (`cols_labels`), le titre (`tab_header`) et la couleur de la partie sup√©rieure du tableau (`tab_style`), les notes (`tab_source_note`) pour avoir un tableau esth√©thique et informatif
6. Transformer la table en tableau interactif avec `opt_interactive`[^note-interactive]
:::

[^note-interactive]: Vous perdrez la mise en forme du _header_ du tableau qui n'est pas conciliable avec l'interactivit√©. 

Les r√©ponses aux diff√©rentes questions sont donn√©es de mani√®re successives ci-dessous.
La table finale, obtenue √† l'issue de l'exercice est la suivante:

```{r}
#| code-fold: true
#| code-summary: "R√©ponse question 1"
#| output: false
library(gt)
table_aeroports <- gt(stats_aeroports_table)
table_aeroports
```

```{r}
#| code-fold: true
#| code-summary: "R√©ponse question 2"
#| output: false
table_aeroports <- table_aeroports %>%
  cols_hide(columns = starts_with("apt"))
table_aeroports
```

```{r}
#| code-fold: true
#| code-summary: "R√©ponse question 3"
#| output: false
table_aeroports <- table_aeroports %>%
  fmt_number(columns = starts_with("pax"), suffixing = TRUE)
table_aeroports
```


```{r}
#| code-fold: true
#| code-summary: "R√©ponse question 4"
#| output: false
table_aeroports <- table_aeroports %>%
  fmt_markdown(columns = "name_clean")
table_aeroports
```

```{r}
#| code-fold: true
#| code-summary: "R√©ponse question 5"
#| output: false
table_aeroports <- table_aeroports %>%
  cols_label(
    name_clean = md("**A√©roport**"),
    paxdep = md("**D√©parts**"),
    paxarr = md("**Arriv√©e**"),
    paxtra = md("**Transit**")
  ) %>%
  tab_header(
    title = md("**Statistiques de fr√©quentation**"),
    subtitle = md("Classement des a√©roports")
  ) %>%
  tab_style(
    style = cell_fill(color = "powderblue"),
    locations = cells_title()
  ) %>%
  tab_source_note(source_note = md("_Source: DGAC, √† partir des donn√©es sur data.gouv.fr_"))
  
table_aeroports
```

```{r}
#| code-fold: true
#| code-summary: "R√©ponse question 6"
table_aeroports <- table_aeroports %>%
  opt_interactive()
table_aeroports
```

  
Nous proposons de transformer ce code en fonction, cela facilitera l'utilisation
ult√©rieure de celui-ci dans notre application. 

::: {.callout-note collapse="false" icon=false}
## `<i class="bi bi-book"></i>`{=html} Exercice 4c (optionnel): transformer en fonction notre cha√Æne `gt`

Cet exercice est optionnel. Transformer le code ci-dessus en fonction. 
Mettre √† jour `main.R` pour utiliser ceci dans votre application.
:::

<details>
<summary>
Code de `R/tables.R`
</summary>
```{.r include="R/tables.R" filename="R/tables.R"}
```
</details>

<details>
<summary>
Code de `main.R`
</summary>
```{.r include="intermediates/exo4c.R" filename="main.R"}
```
</details>


## Carte des a√©roports

La derni√®re valorisation que nous allons int√©grer est une carte interactive
du trafic de nos a√©roports. Cette carte va √™tre assez basique. Si vous
d√©sirez mettre en oeuvre des visualisations plus complexes, vous pouvez
tout √† fait le faire. 

Pour cet exercice, nous allons fixer une date pour prototyper notre 
code. Cela nous facilitera la transformation ult√©rieure en fonction. 

```{r}
months <- 1
years <- 2019
```

Voici √©galement une palette de couleurs qui sera utile √† la fin de l'exercice. 

```{r}
palette <- c("green", "blue", "red")
```

::: {.callout-note collapse="false" icon=false}
## `<i class="bi bi-book"></i>`{=html} Exercice 5: carte a√©rienne du trafic a√©roportuaire

1. Cr√©er un _dataframe_ `trafic_date` en ne conservant que les observations
de `pax_apt_all` √©gales √† un certain mois et ann√©e (vous pouvez vous inspirer d'un `filter` fait pr√©c√©demment). Utiliser celui-ci en faisant
une jointure avec `airports_location` par le biais des variables, respectivement,
`Code.OACI` et `apt`. Nommer ce _dataframe_ `trafic_aeroports`
2. A partir de l'[exemple de d√©marrage de `leaflet`](https://rstudio.github.io/leaflet/articles/markers.html),
cr√©er une carte interactive qui affiche, lorsqu'on clique sur l'un des
marqueurs, le nom de l'a√©roport et sa fr√©quentation. 
3. Cr√©er une variable nomm√©e `volume` qui classe chaque observation dans son [tercile](https://fr.wiktionary.org/wiki/tercile) et transforme la valeur
en couleur √† partir de `palette`.  
4. A partir du code suivant et de la [fonction `addAwesomeMarkers`](https://rstudio.github.io/leaflet/articles/markers.html#awesome-icons),
reproduire une carte similaire √† celle pr√©sent√©e plus bas. 

```r
icons <- awesomeIcons(
  icon = 'plane',
  iconColor = 'black',
  library = 'fa',
  markerColor = trafic_aeroports$color
)
```

:::: {.callout-warning collapse="true"}
## Subtilit√© par rapport √† l'exemple de [la documentation](https://rstudio.github.io/leaflet/articles/markers.html#awesome-icons)
Par rapport √† l'exemple dans [la documentation](https://rstudio.github.io/leaflet/articles/markers.html#awesome-icons),
il faut l√©g√®rement modifier le code de sorte √† faire `icon=icons[]`
et non `icon = icons`.
::::
:::


```{r}
#| code-fold: true
#| code-summary: "Question 1"
trafic_date <- pax_apt_all %>%
  mutate(
    date = as.Date(paste(anmois, "01", sep=""), format = "%Y%m%d")
  ) %>%
  filter(mois %in% months, an %in% years)
trafic_aeroports <- airports_location %>%
  inner_join(trafic_date, by = c("Code.OACI" = "apt"))
```


```{r}
#| output: false
#| code-fold: true
#| code-summary: "Question 2"
library(leaflet)
  
leaflet(trafic_aeroports) %>% addTiles() %>%
  addMarkers(popup = ~paste0(Nom, ": ", trafic)) 
```

```{r}
#| code-fold: true
#| code-summary: "Question 3"
trafic_aeroports <- trafic_aeroports %>%
  mutate(
    volume = ntile(trafic, 3)
) %>%
  mutate(
    color = palette[volume]
  )
```  


```{r}
#| code-fold: true
#| code-summary: "Question 3"
icons <- awesomeIcons(
  icon = 'plane',
  iconColor = 'black',
  library = 'fa',
  markerColor = trafic_aeroports$color
)


carte_interactive <- leaflet(trafic_aeroports) %>% addTiles() %>%
  addAwesomeMarkers(
  icon=icons[],
  label=~paste0(Nom, "", " (",Code.OACI, ") : ", trafic, " voyageurs")
)
carte_interactive
```


Comme pr√©c√©demment, nous proposons
de transformer la production de cette carte en fonction, cela nous permettra
d'avoir une application l√©g√®re. L√† encore c'est un exercice optionnel mais
int√©ressant √† faire pour d√©couvrir la logique de la programmation fonctionnelle. 

::: {.callout-note collapse="false" icon=false}
## `<i class="bi bi-book"></i>`{=html} Exercice 5b (optionnel): une fonction pour notre carte

- Cr√©er une fonction `map_leaflet_airport` avec les arguments `df`, `airports_location`
et `selected_date` produisant la carte. Ins√©rer celle-ci dans le script `R/figures.R`
- Mettre √† jour `main.R` pour utiliser cette fonction dans votre chaine. N'oubliez pas de
d√©finir `selected_date` dans votre script. 
:::

<details>
<summary>
Code de `R/figures.R` √† reprendre
</summary>
```{.r include="R/figures.R" start-line="20" filename="R/figures.R (fin du fichier)"}
```
</details>

<details>
<summary>
Code de `intermediates/exo5.R` √† reprendre
</summary>
```{.r include="intermediates/exo5.R" start-line="20" filename="main.R"}
```
</details>


# Cr√©ation de l'application 

Maintenant tous les ingr√©dients sont l√† pour transformer cette cha√Æne en application
interactive. L'architecture de notre application sera la suivante:

![](img/ui-r.png)

Comme toute application _web_, `Shiny` repose sur deux piliers: 

- l'interface utilisateur (UI) qui pr√©sente au navigateur des actions possibles et affiche des _output_ adapt√©s
- le serveur qui r√©pond √† ces actions de l'utilisateur, produit les _output_ et les envoie √† l'interface

Supprimer les fichiers `ui.R` et `server.R` dans votre dossier de travail. Nous allons les recr√©er progressivement afin de comprendre, pas √† pas, la logique d'une application.

::: {.callout-note collapse="false" icon=false}
## `<i class="bi bi-book"></i>`{=html} Exercice 6: cr√©ation de la structure de l'application

1. Cr√©er le fichier `global.R` √† partir de `main.R` en ne conservant que les lignes jusqu'√† la cr√©ation (incluse)
de l'objet `trafic_aeroports`

<details>
<summary>
Le fichier `global.R` attendu
</summary>
```{.r include="global.R"}
```
</details>

L'objectif de la suite de l'exercice est de comprendre comment fonctionne une
application. Celle-ci sera enrichie ensuite de nos productions graphiques. 

Cr√©er les fichiers `ui.R` et `server.R` √† partir des mod√®les ci-dessous

<details>
<summary>
Code de `ui.R` √† reprendre
</summary>
```{.r include="intermediates/exo6/ui.R" filename="ui.R"}
```
</details>

<details>
<summary>
Code de `server.R` √† reprendre
</summary>
```{.r include="intermediates/exo6/server.R" filename="server.R"}
```
</details>

Lancer l'application en lan√ßant `shiny::runApp()` depuis la console `R`. Si `firefox` affiche un message de blocage de l'ouverture d'une fen√™tre, autoriser celle-ci. 

1. Observer votre console, notamment les messages lors du lancement de l'application
2. Jouer avec les _inputs_ et observer la mani√®re dont l'affichage s'ajuste

Maintenant, se pencher sur le code source et observer l'aller-retour entre les objets du script `ui.R` et `server.R`. 

Tuer l'application avec le bouton stop de la console. 

:::


::: {.callout-note collapse="false" icon=false}
## `<i class="bi bi-book"></i>`{=html} Exercice 7: finaliser l'application

Le sujet le plus difficile, quand on d√©couvre `Shiny` est la gestion de la r√©activit√©,
c'est-√†-dire de l'aller-retour entre interface utilisateur et serveur. 
Pour comprendre cela, la mani√®re la plus directe est sans doute de se plonger
dans le code de l'application compl√®te:

<details>
<summary>
Code de `ui.R` √† reprendre
</summary>
```{.r include="ui.R" filename="ui.R"}
```
</details>

<details>
<summary>
Code de `server.R` √† reprendre
</summary>
```{.r include="server.R" filename="server.R"}
```
</details>

1. Observer la mani√®re dont le fichier `ui.R` a √©volu√©. 
2. Observer les nouveaux √©l√©ments dans `server.R` et la mani√®re dont ceux-ci sont projet√©s ensuite dans l'interface utilisateur

:::

::: {.callout-note collapse="false" icon=false}
## `<i class="bi bi-book"></i>`{=html} Exercice 8 (optionnel): amusez-vous √† enrichir l'application

Cette application √©tait un squelette minimal d'application. N'h√©sitez pas √† cr√©er votre propre version. Voici quelques id√©es:

- Changer l'apparence graphique ;
- Cr√©er une application avec plusieurs pages ; 
- Enrichir les productions graphiques sur l'application...
:::


# Partager cette application: une ouverture vers la mise en production